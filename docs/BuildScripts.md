Build Script
=====

There are the platform prefixes, @windows, @linux and @mac that allow you to perform actions for a single platform.
Lines with that start with // or # are comments. Spaces are trimmed from each line, so you can indent as you please.

Commands
-----

| Name                                 | Arguments                                                 | Description                                                                                                                                                                                                                                                                                                                                      |
|--------------------------------------|-----------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| auth `ARGS`                          | ['try'] 'github' \<PAT²> [login²]                         | Log in to the GitHub API with a personal access token. The login parameter is for organisations and increasing the request limit even more. GitHub auth is required for `dependency github` only. The try keyword will prevent the script from failing if authentication failed. This might be useful if you have mutual exclusive auth sources. |
| sourcemod `ARGS`                     | \<branch> (\<build>&#124;['latest'])                      | Download the specified sourcemod branch, with the given build number or the latest build                                                                                                                                                                                                                                                         |
| dependency `ARGS`                    | ('am'&#124;'forum'&#124;'forums') \<plugin thread id>     | Download the files from a plugin posted on the forums. Directories will be guessed by file extension                                                                                                                                                                                                                                             |
| dependency `ARGS`                    | ('am'&#124;'forum'&#124;'forums') 'patch' \<post id>      | Download the files from a single forum post id. Directories will be guessed again, and the file has to be replaced                                                                                                                                                                                                                               |
| dependency `ARGS`                    | 'github' \<project slug> \<tag name> [archive name]       | Looks up the release tag in the repo. Will download the sources if no other archive was specified                                                                                                                                                                                                                                                |
| dependency `ARGS`                    | 'github' \<project slug> 'latest'                         | Download the archive for the main branch                                                                                                                                                                                                                                                                                                         |
| dependency `ARGS`                    | 'github' \<project slug> \<branch name>'-SNAPSHOT'        | Download the archive for the specified branch. The -SNAPSHOT suffix for the branch name is just to distinguish between release tags                                                                                                                                                                                                              |
| dependency `ARGS`                    | 'limetech' \<project id> (\<version>&#124;\<build>)       | Download a version or build of one of asherkins plugins hosted on limetech.org. Take the project id from the url in the version list                                                                                                                                                                                                             |
| dependency `ARGS`                    | 'raw' \<url>                                              | Has to point to an archive or known file type to be placed into the cache folder                                                                                                                                                                                                                                                                 |
| clone `ARGS`                         | \<url> [branch²] 'into' \<dir²>                           | Requires git to be installed, clones the specified branch into specified directory within spcache                                                                                                                                                                                                                                                |
| compilepool `ARGS`                   | \<size>                                                   | When encountering `spcomp` tasks, collect all consecutive `spcomp` tasks and execute the specified amount of tasks at the same time. Defaults to the amount of CPUs you have                                                                                                                                                                     |
| spcomp `ARGS`                        | ...²                                                      | Args are the same as for the sp compiler. Automatically adds the include directories spcache/addons/sourcemod/scripting/include/; addons/sourcemod/scripting/include/; scripting/include/; include/                                                                                                                                              |
| exec `ARGS`                          | \<commandline²>                                           | Run a command, script cancelles on exit value != 0                                                                                                                                                                                                                                                                                               |
| echo `ARGS`                          | \<message²>                                               | Write a message to std out during dependency resolution phase                                                                                                                                                                                                                                                                                    |
| echo! `ARGS`                         | \<message²>                                               | Write a message to std out during task execution phase                                                                                                                                                                                                                                                                                           |
| die `ARGS`                           | \<message²>                                               | Writes a message to std out during dependency resolution phase and exits with error-level                                                                                                                                                                                                                                                        |
| die! `ARGS`                          | \<message²>                                               | Writes a message to std out during task execution phase and exits with error-level                                                                                                                                                                                                                                                               |
| mkdir `ARGS`                         | \<path²>                                                  | Creates a directory within cwd                                                                                                                                                                                                                                                                                                                   |
| delete/erase/remove `ARGS`           | \<path²>                                                  | Delete a file or directory recursively within cwd                                                                                                                                                                                                                                                                                                |
| move `ARGS`                          | \<from²> ':' \<to²> ['replace' \<mode>]                   | Move a file or directory within cwd.<br>Use `mode` to specify how to handle duplicate files. Possible modes are `All`, `Older`, `Skip` and `Error`(default).                                                                                                                                                                                     |
| copy `ARGS`                          | \<from²> ':' \<to²> ['replace' \<mode>]                   | Copy a file or directory within cwd (like move)                                                                                                                                                                                                                                                                                                  |
| set `ARGS`                           | \<variable> 'to' \<value²>                                | Sets a environment variable or 'argument' variable to the specified value                                                                                                                                                                                                                                                                        |
| set `ARGS`                           | \<variable> ['as' \<format>] from \<file²> \<regex>       | Sets a environment variable or 'argument' variable to a value read from a file. The file is read whole and matched against the regex (Java Regex, MULTILINE is set by default). Format supports capture groups \0 through \9. As this command is more complex, you may quote arguments. Quotes are escaped with double quotes.                   |
| script `ARGS`<br>...<br>end script   | 'lua'                                                     | Execute a block of lua code to manipulate variables. These sandboxes are quite limited and do not get os/io access!                                                                                                                                                                                                                              |
| with files<br>...<br>:release `ARGS` | 'github' \<owner²/repo²>[@branch²] \<tag²>                | Create a new Release on GitHub (or append if the release already exists) with the files listed in the lines between `with files` and `:release ...`                                                                                                                                                                                              |
| with files<br>...<br>:release `ARGS` | ('am'&#124;'forum'&#124;'forums') \<threadid> \<version²> | Update the attachments on an AlliedMods forum thread with the files listed in the lines between `with files` and `:release ...`. Only unpacked files are remove (sp,inc,smx,so,dll,cfg,txt).                                                                                                                                                     |
| with files<br>...<br>:release `ARGS` | 'zip' \<file²> ['auto']                                   | Create a basic release archive with the specified path and name relative to the pwd using the files listed in the lines between `with files` and `:release ...`. Specifying `auto` will try to restructure the included files into a directory tree fit for dropping into a mod directory.                                                       |
| with files<br>...<br>:release `ARGS` | 'updater' \<updaterFile²> \<version²>                     | Patch the content of an updater file using the files listed in the lines between `with files` and `:release ...`. If a version change is detected it will create a patch block. Will create a separate file with a hash list to track file changes.                                                                                              |
| pucpatch `ARGS`                      | \<file²> ':' \<convar²> \<version²>                       | Tries to patch the specified file as 'Plugin Update Checker'-CSV, updating the version value for the specified version convar. Supports limited vim modeline to automatically realign columns.                                                                                                                                                   |

²) denotes that variables are supported

Not all arguments, but most support replacements from environment variables or applications arguments. This is mainly inteded to not leak you auth tokens.
${NAME} is replaced with an environment variable, %{NAME} is replaced with the value from the argument `--<NAME> <VALUE>`. There is one exception however:
${CWD} and %{CWD} are replaced with the path of the loaded build-script.

The release tasks (`with files :release`) only support mod files, so you can not currently ship arbitrary files. This
helps check file type and size limits on the forum as well as path extrapolation for the updater config, as that needs
to know where files go, potentially even while you're using a flat project structure.

Interactive mode has some special commands:
* `quit` or `exit` (or ^C) to exit
* `batch` to switch into batch mode until the next `run`
* `run` to execute the batch. Optional if `-I` was used and input ends.